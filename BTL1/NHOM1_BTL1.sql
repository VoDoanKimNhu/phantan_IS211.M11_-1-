--CREATE CHINHANH
CREATE TABLE cn1.CHINHANH
(
    MACN VARCHAR(4) CONSTRAINT CN_MACN PRIMARY KEY,
    TENCN VARCHAR(20),
    THANHPHO VARCHAR(30)
)
--CREATE NHANVIEN
CREATE TABLE cn1.NHANVIEN
(
    MANV VARCHAR(4) CONSTRAINT NV_MANV PRIMARY KEY,
    TENNV VARCHAR(45),
    GIOITINH VARCHAR(5),
    NGAYSINH DATE,
    SDT VARCHAR(10)
)
--CREATE DATMON
CREATE TABLE cn1.KHACHHANG
(
    MAKH VARCHAR(4) CONSTRAINT KH_MAKH PRIMARY KEY,
    TENKH VARCHAR(40),
    NGAYSINH DATE,
    SDT VARCHAR(10),
    GIOITINH VARCHAR(10),
    LOAIKH VARCHAR(20),
    DIACHI VARCHAR(100) 
)
--CREATE MONAN
CREATE TABLE cn1.MONAN
(
    MAMA VARCHAR(4) CONSTRAINT MA_MAMA PRIMARY KEY,
    TENMA VARCHAR(50),
    DONGIA DECIMAL
)
--CREATE DONHANG
CREATE TABLE cn1.HOADON1
(
    MAHD VARCHAR(4) CONSTRAINT HD1_MAHD PRIMARY KEY,
    MAKH VARCHAR(4),
    TONGTIEN DECIMAL
)
CREATE TABLE cn1.HOADON2
(
    MAHD VARCHAR(4) CONSTRAINT HD2_MAHD PRIMARY KEY,
    MANV VARCHAR(4),
    NGAYHD DATE
)

---CREATE QUANLY
CREATE TABLE cn1.QUANLY
(
    MANV VARCHAR(4),
    MACN VARCHAR(4),
    LUONG DECIMAL,
	CONSTRAINT PK_QL PRIMARY KEY (MANV,MACN)
)
--CREATE CTHD
CREATE TABLE cn1.CTHD
(
    MAHD VARCHAR(4),
    MAMA VARCHAR(4),
    SL NUMBER,
    THANHTIEN DECIMAL,
	CONSTRAINT PK_CTHD PRIMARY KEY (MAHD,MAMA)
)


--RANG BUOC KHOA NGOAI
--BANG QUANLY
ALTER TABLE db.QUANLY
ADD CONSTRAINT FK_QUANLY_CN FOREIGN KEY(MACN) REFERENCES db.CHINHANH(MACN)
ALTER TABLE db.QUANLY
ADD CONSTRAINT FK_QUANLY_CN FOREIGN KEY(MANV) REFERENCES db.NHANVIEN(MANV)

--BANG HOADON
ALTER TABLE db.HOADON
ADD CONSTRAINT FK_THANHTOAN_NV FOREIGN KEY (MANV) REFERENCES db.NHANHVIEN(MANV)

ALTER TABLE db.HOADON
ADD CONSTRAINT FK_THANHTOAN_MA FOREIGN KEY (MAMA) REFERENCES db.MONAN(MAMA)

ALTER TABLE db.HOADON
ADD CONSTRAINT FK_THANHTOAN_KH FOREIGN KEY (MAKH) REFERENCES db.KHACHHANG(MAKH)
-----------------------------------------------------------------------------------------------------------------------------------
--COVERT FORMAT DAY TIME 
ALTER SESSION SET NLS_DATE_FORMAT =' DD/MM/YYYY HH24:MI:SS ';

----DATA Cá»¦A CHI NHANH 1
--TABLE CHINHANH
INSERT INTO cn1.CHINHANH VALUES('CN01', 'CHI NHANH 1', 'Ha Noi');
INSERT INTO cn1.CHINHANH VALUES ('CN02','CHI NHANH 2', 'Ho Chi Minh');
--TABLE NHANVIEN
INSERT INTO cn1.NHANVIEN VALUES('NV01','Nguyen Van Anh','Nam','01/01/2001','0946075986');

INSERT INTO cn1.NHANVIEN VALUES('NV03','Tran Binh Nhu','Nu','11/08/1999', '0942159862');
INSERT INTO cn1.NHANVIEN VALUES('NV04','Vo Duy Khang','Nam','19/07/1998', '0856429751');
INSERT INTO cn1.NHANVIEN VALUES('NV05','Than Thu Quyen','Nu','28/12/2000', '0942568741');

INSERT INTO cn1.NHANVIEN VALUES('NV09','Huynh Ngoc Tran','Nu','05/12/1999', '0281639201');

INSERT INTO cn1.NHANVIEN VALUES('NV16','Nguyen Nhu Quynh','Nu','10/09/1999', '0856447512');
INSERT INTO cn1.NHANVIEN VALUES('NV19','Nguyen Van Hieu','Nam','20/02/2001', '0334256745');

--TABLE QUANLY
INSERT INTO cn1.QUANLY VALUES('NV01','CN01',3000000);
INSERT INTO cn1.QUANLY VALUES('NV03','CN01',4500000);
INSERT INTO cn1.QUANLY VALUES('NV04','CN01',1500000);
INSERT INTO cn1.QUANLY VALUES('NV05','CN01',1950000);

INSERT INTO cn1.QUANLY VALUES('NV09','CN01',2500000);

INSERT INTO cn1.QUANLY VALUES('NV16','CN01',2000000);
INSERT INTO cn1.QUANLY VALUES('NV19','CN01',2000000);

SELECT * FROM CN1.NHANVIEN;

--TABLE KHACHHANG
INSERT INTO cn1.KHACHHANG VALUES('KH01', 'Nguyen Thi Van Anh', '01/02/2002', '0941856942','Nu','VIP','Ha Tinh');
INSERT INTO cn1.KHACHHANG VALUES('KH02', 'Tran An Nhien', '19/05/2002', '0942563254','Nam','Binh thuong','Da Nang');
INSERT INTO cn1.KHACHHANG VALUES('KH03', 'Bui Nguyen Nguyen', '30/01/2003', '0956248952','Nu','Binh thuong','Ha Noi');
INSERT INTO cn1.KHACHHANG VALUES('KH04', 'Nguyen Tran Khanh', '26/11/1999', '0987562136','Nam','VIP','Ho Chi Minh');
INSERT INTO cn1.KHACHHANG VALUES('KH05', 'Dang Thy Thy', '05/04/2002', '0946598760','Nam','VIP','Ha Tinh');

INSERT INTO cn1.KHACHHANG VALUES('KH06', 'Tran Dang Truc Nhan', '01/02/2002', '0909127982','Nam','VIP','Ho Chi Minh');
INSERT INTO cn1.KHACHHANG VALUES('KH07', 'Lai Thanh Hong', '19/05/2002', '0708400254','Nu','Binh thuong','Buon Me Thuot');
INSERT INTO cn1.KHACHHANG VALUES('KH08', 'Tran Quoc Nam', '30/01/2003', '0376811285','Nam','Binh thuong','Ho Chi Minh');
INSERT INTO cn1.KHACHHANG VALUES('KH09', 'Trinh Van Thanh Nga','26/11/1999', '0936862926','Nu','VIP','Hue');
INSERT INTO cn1.KHACHHANG VALUES('KH10', 'Nguyen Vu Hoang Giang', '05/04/2002', '0904859096','Nu','Binh thuong','Quang Ngai');

INSERT INTO cn1.KHACHHANG VALUES('KH11', 'Vo Tuong Vy', '19/04/2001', '0946552469','Nu','Binh thuong','Ha Tinh');
INSERT INTO cn1.KHACHHANG VALUES('KH12', 'Dang Anh Thu', '20/05/2003', '0915789623','Nu','Binh thuong','Ho Chi Minh');
INSERT INTO cn1.KHACHHANG VALUES('KH13', 'Doan Kha Tu', '01/04/1999', '0936793685','Nam','Binh thuong','Dong Nai');
INSERT INTO cn1.KHACHHANG VALUES('KH14', 'Nguyen Anh', '07/07/2002', '0906523689','Nu','Binh thuong','Vung Tau');
INSERT INTO cn1.KHACHHANG VALUES('KH15', 'Nguyen An Nhon', '05/04/2002', '0946567841','Nam','Binh thuong','Vung Tau');

INSERT INTO cn1.KHACHHANG VALUES('KH16', 'Bui Thang Loi', '28/08/2001', '0845212547','Nam','VIP','Quang Binh');
INSERT INTO cn1.KHACHHANG VALUES('KH17', 'Truong Minh Tuan', '20/05/2001', '0845729628','Nam','VIP','Quang Binh');
INSERT INTO cn1.KHACHHANG VALUES('KH18', 'Nguyen Thi Tu', '07/04/1998', '0843722624','Nu','Binh thuong','Ho Chi Minh');
INSERT INTO cn1.KHACHHANG VALUES('KH19', 'Nguyen Nhu Nguyet', '08/09/2000', '0845561218','Nu','Binh thuong','Da Nang');
INSERT INTO cn1.KHACHHANG VALUES('KH20', 'Nguyen Thi Nhan', '05/08/2001', '0334751471','Nu','VIP','Quang Binh');

--TABLE MONAN
INSERT INTO cn1.MONAN VALUES('MA01','Ga kho',30000);
INSERT INTO cn1.MONAN VALUES('MA02','Rau xao',15000);
INSERT INTO cn1.MONAN VALUES('MA03','Canh chua',25000);
INSERT INTO cn1.MONAN VALUES('MA04','Com Trang',10000);
INSERT INTO cn1.MONAN VALUES('MA05','Com Chien',20000);

INSERT INTO cn1.MONAN VALUES('MA06','Ech xao ca ri',30000);
INSERT INTO cn1.MONAN VALUES('MA07','Dau Bap Luoc',13000);
INSERT INTO cn1.MONAN VALUES('MA08','Thit Kho Mam Ruoc',22000);
INSERT INTO cn1.MONAN VALUES('MA09','Thit Kho Hop Vit',25000);
INSERT INTO cn1.MONAN VALUES('MA10','Hot Ga Nuong',10000);

INSERT INTO cn1.MONAN VALUES('MA11','Com Lam',10000);
INSERT INTO cn1.MONAN VALUES('MA12','My Xao',20000);
INSERT INTO cn1.MONAN VALUES('MA13','Ga chien',20000);
INSERT INTO cn1.MONAN VALUES('MA14','Thit nuong',20000);
INSERT INTO cn1.MONAN VALUES('MA15','Rau luoc',10000);

INSERT INTO cn1.MONAN VALUES('MA16','Com Ga',25000);
INSERT INTO cn1.MONAN VALUES('MA17','Com Muc',25000);
INSERT INTO cn1.MONAN VALUES('MA18','Com Tam',25000);
INSERT INTO cn1.MONAN VALUES('MA19','Bun Bo',25000);
INSERT INTO cn1.MONAN VALUES('MA20','Bo Kho',25000);

--TABLE HOADON1
INSERT INTO cn1.HOADON1 VALUES('HD01','KH01',75000);
INSERT INTO cn1.HOADON1 VALUES('HD21','KH01',60000);

INSERT INTO cn1.HOADON1 VALUES('HD02','KH03',30000);
INSERT INTO cn1.HOADON1 VALUES('HD04','KH05',65000);
INSERT INTO cn1.HOADON1 VALUES('HD05','KH03',60000);

INSERT INTO cn1.HOADON1 VALUES('HD06','KH09',140000);
INSERT INTO cn1.HOADON1 VALUES('HD07','KH10',60000);
INSERT INTO cn1.HOADON1 VALUES('HD08','KH06',330000);

INSERT INTO cn1.HOADON1 VALUES('HD16','KH16',25000);
INSERT INTO cn1.HOADON1 VALUES('HD17','KH17',25000);

INSERT INTO cn1.HOADON1 VALUES('HD23','KH02',175000);
INSERT INTO cn1.HOADON1 VALUES('HD26','KH07',200000);

INSERT INTO cn1.HOADON1 VALUES('HD31','KH01',45000);
INSERT INTO cn1.HOADON1 VALUES('HD33','KH01',60000);
INSERT INTO cn1.HOADON1 VALUES('HD34','KH01',100000);
INSERT INTO cn1.HOADON1 VALUES('HD36','KH01',115000);

INSERT INTO cn1.HOADON1 VALUES('HD38','KH05',140000);
INSERT INTO cn1.HOADON1 VALUES('HD39','KH01',50000);
INSERT INTO cn1.HOADON1 VALUES('HD40','KH13',117000);
--TABLE HOADON2
SELECT * FROM CN1.HOADON2
INSERT INTO cn1.HOADON2 VALUES('HD01','NV01', '01/01/2021 12:12:04');


INSERT INTO cn1.HOADON2 VALUES('HD02','NV01','03/01/2021 13:23:30');
INSERT INTO cn1.HOADON2 VALUES('HD04','NV05', '15/02/2021 18:30:00');
INSERT INTO cn1.HOADON2 VALUES('HD05','NV03', '16/02/2021 15:29:45');

INSERT INTO cn1.HOADON2 VALUES('HD06','NV07','17/02/2021 19:27:39');
INSERT INTO cn1.HOADON2 VALUES('HD07','NV06','10/03/2021 19:54:17');
INSERT INTO cn1.HOADON2 VALUES('HD08','NV09','05/04/2021 20:02:40');

INSERT INTO cn1.HOADON2 VALUES('HD16','NV19', '28/08/2021 09:22:05');
INSERT INTO cn1.HOADON2 VALUES('HD17','NV16', '29/08/2021 09:30:30');

INSERT INTO cn1.HOADON2 VALUES('HD21','NV01', '06/09/2021 19:12:04');

INSERT INTO cn1.HOADON2 VALUES('HD23','NV15', '24/09/2021 13:11:59');
INSERT INTO cn2.HOADON2 VALUES('HD26','NV05','01/10/2021 20:57:15');

INSERT INTO cn1.HOADON2 VALUES('HD31','NV02', '02/11/2021 12:48:15');
INSERT INTO cn1.HOADON2 VALUES('HD33','NV13', '05/11/2021 11:19:20');
INSERT INTO cn1.HOADON2 VALUES('HD34','NV14', '15/11/2021 14:57:37');
INSERT INTO cn1.HOADON2 VALUES('HD36','NV08', '24/11/2021 12:43:18');

INSERT INTO cn1.HOADON2 VALUES('HD38','NV01','09/12/2021 19:19:01');
INSERT INTO cn1.HOADON2 VALUES('HD39','NV06','09/12/2021 19:54:17');
INSERT INTO cn1.HOADON2 VALUES('HD40','NV04','09/12/2021 20:15:46');
--TABLE CTHD
INSERT INTO cn1.CTHD VALUES('HD01','MA01',2, 60000);
INSERT INTO cn1.CTHD VALUES('HD21','MA01',2, 60000);

INSERT INTO cn1.CTHD VALUES('HD01','MA02',1, 15000);
INSERT INTO cn1.CTHD VALUES('HD02','MA01',1,30000); 
INSERT INTO cn1.CTHD VALUES('HD04','MA05',1,20000);
INSERT INTO cn1.CTHD VALUES('HD04','MA02',3, 45000);
INSERT INTO cn1.CTHD VALUES('HD05','MA05',3,60000); 


INSERT INTO cn1.CTHD VALUES('HD06','MA10',5,50000);
INSERT INTO cn1.CTHD VALUES('HD06','MA01',1,30000);
INSERT INTO cn1.CTHD VALUES('HD06','MA06',2,60000);
INSERT INTO cn1.CTHD VALUES('HD07','MA06',2,60000);
INSERT INTO cn1.CTHD VALUES('HD08','MA08',3,66000);
INSERT INTO cn1.CTHD VALUES('HD08','MA02',3,45000);

INSERT INTO cn1.CTHD VALUES('HD16','MA18',1,25000); 
INSERT INTO cn1.CTHD VALUES('HD17','MA16',1,25000);

INSERT INTO cn1.CTHD VALUES('HD23','MA10',6,60000);
INSERT INTO cn1.CTHD VALUES('HD23','MA05',2,40000);
INSERT INTO cn1.CTHD VALUES('HD23','MA20',3,75000);
INSERT INTO cn1.CTHD VALUES('HD26','MA12',1,20000);
INSERT INTO cn1.CTHD VALUES('HD26','MA04',3,30000);
INSERT INTO cn1.CTHD VALUES('HD26','MA19',2,50000);
INSERT INTO cn1.CTHD VALUES('HD26','MA17',2,50000);
INSERT INTO cn1.CTHD VALUES('HD26','MA20',2,50000);

INSERT INTO cn1.CTHD VALUES('HD31','MA11',2,20000);
INSERT INTO cn1.CTHD VALUES('HD31','MA03',1,25000);
INSERT INTO cn1.CTHD VALUES('HD33','MA15',3,30000);
INSERT INTO cn1.CTHD VALUES('HD33','MA04',3,30000);
INSERT INTO cn1.CTHD VALUES('HD34','MA18',3,75000);
INSERT INTO cn1.CTHD VALUES('HD34','MA09',1,25000);
INSERT INTO cn1.CTHD VALUES('HD36','MA20',1,25000);
INSERT INTO cn1.CTHD VALUES('HD36','MA05',1,20000);
INSERT INTO cn1.CTHD VALUES('HD36','MA13',2,40000);
INSERT INTO cn1.CTHD VALUES('HD36','MA10',3,30000);

INSERT INTO cn1.CTHD VALUES('HD38','MA13',4,80000);
INSERT INTO cn1.CTHD VALUES('HD38','MA06',2,60000);
INSERT INTO cn1.CTHD VALUES('HD39','MA16',2,50000);
INSERT INTO cn1.CTHD VALUES('HD40','MA07',4,52000);
INSERT INTO cn1.CTHD VALUES('HD40','MA03',1,25000);
INSERT INTO cn1.CTHD VALUES('HD40','MA05',2,40000);

delete cn1.cthd;
drop trigger TRG_HD1_UPDATE;
drop trigger TRG_CTHD;

COMMIT;

-----------------------------------------------------------------------------------------------------------------------------------
----DATA Cá»¦A CHI NHANH 2
--TABLE CHINHANH
INSERT INTO cn2.CHINHANH VALUES('CN01', 'CHI NHANH 1', 'Ha Noi');
INSERT INTO cn2.CHINHANH VALUES ('CN02','CHI NHANH 2', 'Ho Chi Minh');
--TABLE NHANVIEN
INSERT INTO cn2.NHANVIEN VALUES('NV02','Nguyen Thi Huong Thi','Nu','02/09/1997', '0908564782');

INSERT INTO cn2.NHANVIEN VALUES('NV06','Hoang Thanh Chien','Nam','30/04/1990','0923375416');
INSERT INTO cn2.NHANVIEN VALUES('NV07','Tran Dang Thuy Trang','Nu','13/06/1993','0393035670');
INSERT INTO cn2.NHANVIEN VALUES('NV08','Vu Nguyen Kha','Nam','27/05/1998', '0302648862');
INSERT INTO cn2.NHANVIEN VALUES('NV10','Tran Trieu Vy','Nu','21/10/1996', '0923491141');

INSERT INTO cn2.NHANVIEN VALUES('NV11','Vo Khanh An', 'Nam', '28/07/2000', '0936568741');
INSERT INTO cn2.NHANVIEN VALUES('NV12','Nguyen Huyen Chau', 'Nu', '03/01/2001', '0942563331');
INSERT INTO cn2.NHANVIEN VALUES('NV13','Nguyen Khanh Chau', 'Nu', '03/01/2001', '0942168241');
INSERT INTO cn2.NHANVIEN VALUES('NV14','Dao Nguyen Trung', 'Nam', '28/11/1999', '0925789741');
INSERT INTO cn2.NHANVIEN VALUES('NV15','Vo Thien An', 'Nam', '10/09/2002', '0952637841');

INSERT INTO cn2.NHANVIEN VALUES('NV17','Nguyen Thi Hong','Nu','11/08/2001', '0334217128');
INSERT INTO cn2.NHANVIEN VALUES('NV18','Nguyen Van Hieu','Nam','20/02/2001', '0834236744');
INSERT INTO cn2.NHANVIEN VALUES('NV20','Nguyen Van Hieu','Nam','20/02/2001', '0854255775');

--TABLE QUANLY
INSERT INTO cn2.QUANLY VALUES('NV02','CN02',5000000);

INSERT INTO cn2.QUANLY VALUES('NV06','CN02',2150000);
INSERT INTO cn2.QUANLY VALUES('NV07','CN02',2200000);
INSERT INTO cn2.QUANLY VALUES('NV08','CN02',2000000);
INSERT INTO cn2.QUANLY VALUES('NV10','CN02',1890000);

INSERT INTO cn2.QUANLY VALUES('NV11','CN02',1500000);
INSERT INTO cn2.QUANLY VALUES('NV12','CN02',2000000);
INSERT INTO cn2.QUANLY VALUES('NV13','CN02',1500000);
INSERT INTO cn2.QUANLY VALUES('NV14','CN02',2000000);
INSERT INTO cn2.QUANLY VALUES('NV15','CN02',1700000);

INSERT INTO cn2.QUANLY VALUES('NV17','CN02',2000000);
INSERT INTO cn2.QUANLY VALUES('NV18','CN02',2000000);
INSERT INTO cn2.QUANLY VALUES('NV20','CN02',2000000);

--TABLE KHACHHANG NHAN BAN O CN1
INSERT INTO cn2.KHACHHANG VALUES('KH01', 'Nguyen Thi Van Anh', '01/02/2002', '0941856942','Nu','VIP','Ha Tinh');
INSERT INTO cn2.KHACHHANG VALUES('KH02', 'Tran An Nhien', '19/05/2002', '0942563254','Nam','Binh thuong','Da Nang');
INSERT INTO cn2.KHACHHANG VALUES('KH03', 'Bui Nguyen Nguyen', '30/01/2003', '0956248952','Nu','Binh thuong','Ha Noi');
INSERT INTO cn2.KHACHHANG VALUES('KH04', 'Nguyen Tran Khanh', '26/11/1999', '0987562136','Nam','VIP','Ho Chi Minh');
INSERT INTO cn2.KHACHHANG VALUES('KH05', 'Dang Thy Thy', '05/04/2002', '0946598760','Nam','VIP','Ha Tinh');

INSERT INTO cn2.KHACHHANG VALUES('KH06', 'Tran Dang Truc Nhan', '01/02/2002', '0909127982','Nam','VIP','Ho Chi Minh');
INSERT INTO cn2.KHACHHANG VALUES('KH07', 'Lai Thanh Hong', '19/05/2002', '0708400254','Nu','Binh thuong','Buon Me Thuot');
INSERT INTO cn2.KHACHHANG VALUES('KH08', 'Tran Quoc Nam', '30/01/2003', '0376811285','Nam','Binh thuong','Ho Chi Minh');
INSERT INTO cn2.KHACHHANG VALUES('KH09', 'Trinh Van Thanh Nga','26/11/1999', '0936862926','Nu','VIP','Hue');
INSERT INTO cn2.KHACHHANG VALUES('KH10', 'Nguyen Vu Hoang Giang', '05/04/2002', '0904859096','Nu','Binh thuong','Quang Ngai');

INSERT INTO cn2.KHACHHANG VALUES('KH11', 'Vo Tuong Vy', '19/04/2001', '0946552469','Nu','Binh thuong','Ha Tinh');
INSERT INTO cn2.KHACHHANG VALUES('KH12', 'Dang Anh Thu', '20/05/2003', '0915789623','Nu','Binh thuong','Ho Chi Minh');
INSERT INTO cn2.KHACHHANG VALUES('KH13', 'Doan Kha Tu', '01/04/1999', '0936793685','Nam','Binh thuong','Dong Nai');
INSERT INTO cn2.KHACHHANG VALUES('KH14', 'Nguyen Anh', '07/07/2002', '0906523689','Nu','Binh thuong','Vung Tau');
INSERT INTO cn2.KHACHHANG VALUES('KH15', 'Nguyen An Nhon', '05/04/2002', '0946567841','Nam','Binh thuong','Vung Tau');

INSERT INTO cn2.KHACHHANG VALUES('KH16', 'Bui Thang Loi', '28/08/2001', '0845212547','Nam','VIP','Quang Binh');
INSERT INTO cn2.KHACHHANG VALUES('KH17', 'Truong Minh Tuan', '20/05/2001', '0845729628','Nam','VIP','Quang Binh');
INSERT INTO cn2.KHACHHANG VALUES('KH18', 'Nguyen Thi Tu', '07/04/1998', '0843722624','Nu','Binh thuong','Ho Chi Minh');
INSERT INTO cn2.KHACHHANG VALUES('KH19', 'Nguyen Nhu Nguyet', '08/09/2000', '0845561218','Nu','Binh thuong','Da Nang');
INSERT INTO cn2.KHACHHANG VALUES('KH20', 'Nguyen Thi Nhan', '05/08/2001', '0334751471','Nu','VIP','Quang Binh');

--TABLE MONAN
INSERT INTO cn2.MONAN VALUES('MA01','Ga kho',30000);
INSERT INTO cn2.MONAN VALUES('MA02','Rau xao',15000);
INSERT INTO cn2.MONAN VALUES('MA03','Canh chua',25000);
INSERT INTO cn2.MONAN VALUES('MA04','Com Trang',10000);
INSERT INTO cn2.MONAN VALUES('MA05','Com Chien',20000);

INSERT INTO cn2.MONAN VALUES('MA06','Ech xao ca ri',30000);
INSERT INTO cn2.MONAN VALUES('MA07','Dau Bap Luoc',13000);
INSERT INTO cn2.MONAN VALUES('MA08','Thit Kho Mam Ruoc',22000);
INSERT INTO cn2.MONAN VALUES('MA09','Thit Kho Hop Vit',25000);
INSERT INTO cn2.MONAN VALUES('MA10','Hot Ga Nuong',10000);

INSERT INTO cn2.MONAN VALUES('MA11','Com Lam',10000);
INSERT INTO cn2.MONAN VALUES('MA12','My Xao',20000);
INSERT INTO cn2.MONAN VALUES('MA13','Ga chien',20000);
INSERT INTO cn2.MONAN VALUES('MA14','Thit nuong',20000);
INSERT INTO cn2.MONAN VALUES('MA15','Rau luoc',10000);

INSERT INTO cn2.MONAN VALUES('MA16','Com Ga',25000);
INSERT INTO cn2.MONAN VALUES('MA17','Com Muc',25000);
INSERT INTO cn2.MONAN VALUES('MA18','Com Tam',25000);
INSERT INTO cn2.MONAN VALUES('MA19','Bun Bo',25000);
INSERT INTO cn2.MONAN VALUES('MA20','Bo Kho',25000);

--TABLE HOADON1
INSERT INTO cn2.HOADON1 VALUES('HD03','KH02',60000);

INSERT INTO cn2.HOADON1 VALUES('HD09','KH07',133000);
INSERT INTO cn2.HOADON1 VALUES('HD10','KH06',85000);

INSERT INTO cn2.HOADON1 VALUES('HD11','KH01',20000);
INSERT INTO cn2.HOADON1 VALUES('HD12','KH01',20000);
INSERT INTO cn2.HOADON1 VALUES('HD13','KH11',40000);
INSERT INTO cn2.HOADON1 VALUES('HD14','KH14',20000);
INSERT INTO cn2.HOADON1 VALUES('HD15','KH15',20000);

INSERT INTO cn2.HOADON1 VALUES('HD18','KH18',25000);
INSERT INTO cn2.HOADON1 VALUES('HD19','KH19',25000);
INSERT INTO cn2.HOADON1 VALUES('HD20','KH20',25000);
INSERT INTO cn2.HOADON1 VALUES('HD22','KH04',155000);
INSERT INTO cn2.HOADON1 VALUES('HD24','KH19',160000);
INSERT INTO cn2.HOADON1 VALUES('HD25','KH15',125000);

INSERT INTO cn2.HOADON1 VALUES('HD27','KH09',280000);
INSERT INTO cn2.HOADON1 VALUES('HD28','KH01',44000);
INSERT INTO cn2.HOADON1 VALUES('HD29','KH03',30000);
INSERT INTO cn2.HOADON1 VALUES('HD30','KH03',40000);

INSERT INTO cn2.HOADON1 VALUES('HD32','KH01',79000);
INSERT INTO cn2.HOADON1 VALUES('HD35','KH01',200000);
INSERT INTO cn2.HOADON1 VALUES('HD37','KH01',80000);

--TABLE HOADON2
INSERT INTO cn2.HOADON2 VALUES('HD03','NV02','02/01/2021 09:12:04');

INSERT INTO cn2.HOADON2 VALUES('HD09','NV01','07/05/2021 20:30:55');
INSERT INTO cn2.HOADON2 VALUES('HD10','NV08','08/05/2021 18:41:11');

INSERT INTO cn2.HOADON2 VALUES('HD11','NV11','14/06/2021 11:29:45');
INSERT INTO cn2.HOADON2 VALUES('HD12','NV11','15/06/2021 10:30:00');
INSERT INTO cn2.HOADON2 VALUES('HD13','NV15','18/07/2021 12:00:45');
INSERT INTO cn2.HOADON2 VALUES('HD14','NV14','19/07/2021 10:29:45');
INSERT INTO cn2.HOADON2 VALUES('HD15','NV13','10/08/2021 11:30:00');

INSERT INTO cn2.HOADON2 VALUES('HD18','NV17','21/08/2021 06:39:06');
INSERT INTO cn2.HOADON2 VALUES('HD19','NV20','25/08/2021 09:45:37');
INSERT INTO cn2.HOADON2 VALUES('HD20','NV19','06/09/2021 17:57:35');
INSERT INTO cn2.HOADON2 VALUES('HD22','NV04','07/09/2021 15:28:01');
INSERT INTO cn2.HOADON2 VALUES('HD24','NV12','24/09/2021 19:58:22');
INSERT INTO cn2.HOADON2 VALUES('HD25','NV02','25/09/2021 07:08:12');

INSERT INTO cn2.HOADON2 VALUES('HD27','NV17','07/10/2021 09:18:28');
INSERT INTO cn2.HOADON2 VALUES('HD28','NV01','08/10/2021 14:23:00');
INSERT INTO cn2.HOADON2 VALUES('HD29','NV02','26/10/2021 19:29:15');
INSERT INTO cn2.HOADON2 VALUES('HD30','NV17','29/10/2021 17:15:20');

INSERT INTO cn2.HOADON2 VALUES('HD32','NV19','02/12/2021 20:29:15');
INSERT INTO cn2.HOADON2 VALUES('HD35','NV03','06/12/2021 12:08:20');
INSERT INTO cn2.HOADON2 VALUES('HD37','NV07','08/12/2021 17:29:06');
--TABLE CTHD
INSERT INTO cn2.CTHD VALUES('HD03','MA02',2,30000);
INSERT INTO cn2.CTHD VALUES('HD03','MA04',3,30000);

INSERT INTO cn2.CTHD VALUES('HD09','MA07',3,39000);
INSERT INTO cn2.CTHD VALUES('HD09','MA09',2,50000);
INSERT INTO cn2.CTHD VALUES('HD09','MA08',2,44000);
INSERT INTO cn2.CTHD VALUES('HD10','MA05',3,60000);
INSERT INTO cn2.CTHD VALUES('HD10','MA03',1,25000);

INSERT INTO cn2.CTHD VALUES('HD11','MA13',1,20000);
INSERT INTO cn2.CTHD VALUES('HD12','MA14',1,20000);
INSERT INTO cn2.CTHD VALUES('HD13','MA14',2,40000);
INSERT INTO cn2.CTHD VALUES('HD14','MA11',2,20000);
INSERT INTO cn2.CTHD VALUES('HD15','MA05',1,20000);

INSERT INTO cn2.CTHD VALUES('HD18','MA17',1,25000);
INSERT INTO cn2.CTHD VALUES('HD19','MA20',1,25000);
INSERT INTO cn2.CTHD VALUES('HD20','MA19',1,25000);
INSERT INTO cn2.CTHD VALUES('HD22','MA09',2,50000);
INSERT INTO cn2.CTHD VALUES('HD22','MA17',3,75000);
INSERT INTO cn2.CTHD VALUES('HD22','MA02',2,30000);
INSERT INTO cn2.CTHD VALUES('HD24','MA05',3,60000);
INSERT INTO cn2.CTHD VALUES('HD24','MA18',4,100000);
INSERT INTO cn2.CTHD VALUES('HD25','MA19',5,125000);

INSERT INTO cn2.CTHD VALUES('HD27','MA18',3,75000);
INSERT INTO cn2.CTHD VALUES('HD27','MA14',5,100000);
INSERT INTO cn2.CTHD VALUES('HD27','MA10',4,40000);
INSERT INTO cn2.CTHD VALUES('HD27','MA07',5,65000);
INSERT INTO cn2.CTHD VALUES('HD28','MA08',2,44000);
INSERT INTO cn2.CTHD VALUES('HD29','MA11',3,30000);
INSERT INTO cn2.CTHD VALUES('HD30','MA14',2,40000);
INSERT INTO cn2.CTHD VALUES('HD30','MA02',2,30000);

INSERT INTO cn2.CTHD VALUES('HD32','MA07',3,39000);
INSERT INTO cn2.CTHD VALUES('HD32','MA14',2,40000);
INSERT INTO cn2.CTHD VALUES('HD35','MA12',2,40000);
INSERT INTO cn2.CTHD VALUES('HD35','MA19',2,50000);
INSERT INTO cn2.CTHD VALUES('HD35','MA06',2,60000);
INSERT INTO cn2.CTHD VALUES('HD35','MA16',2,50000);
INSERT INTO cn2.CTHD VALUES('HD37','MA02',2,30000);
INSERT INTO cn2.CTHD VALUES('HD37','MA17',2,50000);

-----------------------------------------------------------------------------------------------------------------------------------
SELECT * FROM CN1.KHACHHANG;
SELECT * FROM CN2.KHACHHANG@DBLINK;
---CAU TRUY VAN
---CAU 1: LAY TEN KHACH HANG VA TAT CA CAC MON AN MA KHACH HANG DA MUA(truy van tu chi nhanh 1)
SELECT DISTINCT TENKH, TENMA
FROM
    (SELECT * FROM cn1.KHACHHANG KH, cn1.MONAN MA, cn1.HOADON1 HDCN1, cn1.CTHD
    WHERE KH.MAKH = HDCN1.MAKH AND MA.MAMA = CTHD.MAMA AND CTHD.MAHD = HDCN1.MAHD
    UNION
    SELECT * FROM cn1.KHACHHANG KH, cn2.MONAN@DBLINK MA, cn2.HOADON1@DBLINK HDCN2, cn2.CTHD@DBLINK
    WHERE KH.MAKH = HDCN2.MAKH AND MA.MAMA = CTHD.MAMA AND CTHD.MAHD = HDCN2.MAHD);

---CAU 2: TIM MON AN DUOC IT KHACH HANG MUA NHAT TU TRUOC TOI GIO

SELECT MAMA, COUNT(SLMA) AS SL
FROM (
        SELECT MAMA, SL AS SLMA
        FROM CN1.CTHD CTHD1
        UNION ALL
        SELECT MAMA, SL AS SLMA
        FROM CN2.CTHD@DBLINK CTHD2
        )
        HAVING COUNT(MAMA) <= ALL ( select count(SLMA)
                                    FROM(
                                        SELECT MAMA, SL AS SLMA
                                        FROM CN1.CTHD CTHD1
                                        UNION ALL
                                        SELECT MAMA, SL AS SLMA
                                        FROM CN2.CTHD@DBLINK CTHD2
                                    )
                                    GROUP BY MAMA
                                    )
GROUP BY MAMA
---CAU 3: (GOM NHOM) TINH TONG SO TIEN MA KHACH HANG DA THANH TOAN --very good
SELECT A.MAKH, SUM(A.TONG)
FROM(
    SELECT KH.MAKH,SUM(TONGTIEN) AS TONG FROM cn1.KHACHHANG KH, cn1.HOADON1 HDCN1
    WHERE KH.MAKH = HDCN1.MAKH 
    GROUP BY KH.MAKH
    UNION
    SELECT KH.MAKH,SUM(TONGTIEN) AS TONG FROM cn1.KHACHHANG KH,cn2.HOADON1@DBLINK HDCN2
    WHERE  KH.MAKH = HDCN2.MAKH
    GROUP BY KH.MAKH
) A
GROUP BY A.MAKH;

--CAU 4: TIM MON AN Mï¿½ NU AN NAM CHUA AN

    (SELECT MA.MAMA
    FROM CN1.CTHD CT, CN1.HOADON1 HD, CN1.KHACHHANG KH, CN1.MONAN MA
    WHERE CT.MAHD = HD.MAHD AND CT.MAMA = MA.MAMA AND KH.MAKH = HD.MAKH
    AND KH.GIOITINH ='Nu'
    UNION 
    SELECT MA.MAMA
    FROM CN2.CTHD@DBLINK CT, CN2.HOADON1@DBLINK HD, CN2.KHACHHANG@DBLINK KH, CN2.MONAN@DBLINK MA
    WHERE CT.MAHD = HD.MAHD AND CT.MAMA = MA.MAMA AND KH.MAKH = HD.MAKH
    AND KH.GIOITINH ='Nu')
MINUS
    (SELECT MA.MAMA
    FROM CN1.CTHD CT, CN1.HOADON1 HD, CN1.KHACHHANG KH, CN1.MONAN MA
    WHERE CT.MAHD = HD.MAHD AND CT.MAMA = MA.MAMA AND KH.MAKH = HD.MAKH
    AND KH.GIOITINH ='Nam'
    UNION
    SELECT MA.MAMA
    FROM CN2.CTHD@DBLINK CT, CN2.HOADON1@DBLINK HD, CN2.KHACHHANG@DBLINK KH, CN2.MONAN@DBLINK MA
    WHERE CT.MAHD = HD.MAHD AND CT.MAMA = MA.MAMA AND KH.MAKH = HD.MAKH
    AND KH.GIOITINH ='Nam')
-- CAU 5: TU TAI KHOAN TRUONG CHI NHANH DUA RA TENNV BAN DC NHIEU NHAT

CREATE OR REPLACE FUNCTION FUNC_TEN(HOTEN IN VARCHAR2)
RETURN VARCHAR2 
IS
    TEN VARCHAR2(20);
    MAX_SL NUMBER;
BEGIN

    select length (regexp_replace(HOTEN, '[^ ]+'))  + 1 INTO MAX_SL
    from dual 
    connect by level <= length (regexp_replace(HOTEN, '[^,]+'))  + 1;
    TEN := regexp_substr(HOTEN, '[^ ]+', 1, MAX_SL);
    RETURN TEN;
END;


SELECT NV.MANV, FUNC_TEN(NV.TENNV) 
    AS TENNHANVIEN, SUM(TONGTIEN) AS DOANHSO
FROM CN1.HOADON1 HD1, CN1.HOADON2 HD2, CN1.NHANVIEN NV
WHERE HD1.MAHD = HD2.MAHD AND HD2.MANV = NV.MANV
GROUP BY NV.MANV, NV.TENNV
HAVING SUM(TONGTIEN)>=ALL(
                        SELECT SUM(TONGTIEN)
                        FROM CN1.HOADON1 HD1, CN1.HOADON2 HD2, CN1.NHANVIEN NV
                        WHERE HD1.MAHD = HD2.MAHD AND HD2.MANV = NV.MANV
                        GROUP BY NV.MANV)
---YEU CAU 2:
commit;
----FUNCTION
--create or replace type tMyValues as object(yr number, mn number, dy number)

CREATE OR REPLACE TYPE R_TYPE as object
(
    DOANHTHU DECIMAL,
    MAKH VARCHAR2(4),
    TONGDT DECIMAL 
)
/
CREATE OR REPLACE FUNCTION TTKH(THANG IN NUMBER)
RETURN R_TYPE
IS
    FUNC_DT DECIMAL;
    FUNC_MAKH VARCHAR2(4);
    FUNC_TONGDT DECIMAL;
BEGIN

        SELECT SUM(DOANHTHU) AS DT INTO FUNC_DT
        FROM
            (   SELECT SUM(TONGTIEN) AS DOANHTHU
                FROM CN1.HOADON2 HD2, CN1.HOADON1 HD1
                WHERE HD1.MAHD = HD2.MAHD AND extract(month from NGAYHD) = THANG
                        AND extract(YEAR from HD2.NGAYHD) = extract(YEAR from SYSDATE)
            UNION ALL
                SELECT SUM(TONGTIEN) AS DOANHTHU
                FROM CN2.HOADON2@DBLINK HD2, CN2.HOADON1@DBLINK HD1
                WHERE HD1.MAHD = HD2.MAHD AND extract(month from NGAYHD) = THANG
                        AND extract(YEAR from HD2.NGAYHD) = extract(YEAR from SYSDATE));

        SELECT MAKH, TONGTHANHTOAN INTO  FUNC_MAKH, FUNC_TONGDT
        FROM   
            (SELECT MAKH, SUM(TONG) AS TONGTHANHTOAN
            FROM
                (
                    SELECT KH.MAKH, SUM(TONGTIEN) AS TONG
                    FROM CN1.KHACHHANG KH, CN1.HOADON1 HD1, CN1.HOADON2 HD2
                    WHERE KH.MAKH = HD1.MAKH AND HD1.MAHD = HD2.MAHD 
                            AND extract(month from HD2.NGAYHD) = THANG
                            AND extract(YEAR from HD2.NGAYHD) = extract(YEAR from SYSDATE)
                    GROUP BY KH.MAKH
                UNION ALL
                    SELECT KH.MAKH, SUM(TONGTIEN) AS TONG
                    FROM CN2.KHACHHANG@DBLINK KH, CN2.HOADON1@DBLINK HD1, CN2.HOADON2@DBLINK HD2
                    WHERE KH.MAKH = HD1.MAKH AND HD1.MAHD = HD2.MAHD 
                            AND extract(month from HD2.NGAYHD) = THANG
                            AND extract(YEAR from HD2.NGAYHD) = extract(YEAR from SYSDATE)
                    GROUP BY KH.MAKH
                )
            GROUP BY MAKH
            ORDER BY SUM(TONG) DESC
            )
        WHERE ROWNUM = 1;
        
    RETURN NEW R_TYPE(FUNC_DT,FUNC_MAKH, FUNC_TONGDT);
END;
----RUN
SET SERVEROUT ON

DECLARE 
    KETQUA R_TYPE;
BEGIN
    KETQUA := TTKH(8);
    dbms_output.put_line('DOANH THU: '||KETQUA.DOANHTHU);
    dbms_output.put_line('MAKH: '||KETQUA.MAKH);
    dbms_output.put_line('TONGDT: '||KETQUA.TONGDT);
END;


---PROCEDURE
CREATE OR REPLACE PROCEDURE PROC_DANHGIALKHTHEOTHANG (proc_thang NUMBER)
IS
    CURSOR cs_KHACHHANG is
        SELECT MAKH,LOAIKH FROM cn2.KHACHHANG;
    proc_makh varchar2(10);
    proc_lkh varchar2(20);
    ktra NUMBER;
    proc_tongtien DECIMAL;
BEGIN
    OPEN cs_KHACHHANG;
        LOOP
        FETCH cs_KHACHHANG into proc_makh,proc_lkh;
        EXIT WHEN cs_KHACHHANG%NOTFOUND;
            IF proc_lkh = 'VIP' THEN
                select count(MAHD) into ktra from 
                (
                select HD1.MAHD
                from cn2.HOADON1 HD1, cn2.HOADON2 HD2
                where HD1.MAHD = HD2.MAHD AND MAKH = proc_makh 
                AND EXTRACT(MONTH FROM NGAYHD)= proc_thang
                AND EXTRACT(YEAR FROM NGAYHD) = EXTRACT(YEAR FROM SYSDATE)
                UNION ALL
                select HD1.MAHD
                from cn1.HOADON1@dblCN1 HD1, cn1.HOADON2@dblCN1 HD2
                where HD1.MAHD = HD2.MAHD AND MAKH = proc_makh 
                AND EXTRACT(MONTH FROM NGAYHD)= proc_thang
                AND EXTRACT(YEAR FROM NGAYHD) = EXTRACT(YEAR FROM SYSDATE)
                );
                IF ktra = 0 THEN
                    UPDATE cn2.KHACHHANG
                    SET LOAIKH = 'Binh thuong'
                    WHERE MAKH = proc_makh;
                    
                    UPDATE cn1.KHACHHANG@dblCN1
                    SET LOAIKH = 'Binh thuong'
                    WHERE MAKH = proc_makh;
                END IF;
            ELSE 
                select sum(TongTien) into proc_tongtien
                from 
                (
                select HD1.MAHD,TongTien from cn2.HOADON1 HD1, cn2.HOADON2 HD2 
                where HD1.MAHD = HD2.MAHD AND MAKH = proc_makh AND extract(month from NGAYHD)= proc_thang
                UNION ALL
                select HD1.MAHD,TongTien from cn1.HOADON1@dblCN1 HD1, cn1.HOADON2@dblCN1 HD2
                where HD1.MAHD = HD2.MAHD AND MAKH = proc_makh AND extract(month from NGAYHD)= proc_thang
                );
                IF proc_tongtien >=500000 THEN
                    UPDATE cn2.KHACHHANG
                    SET LOAIKH = 'VIP'
                    WHERE MAKH = proc_lkh;
                    
                    UPDATE cn1.KHACHHANG@dblCN1
                    SET LOAIKH = 'VIP'
                    WHERE MAKH = proc_lkh;
                END IF;
            END IF;
        END LOOP;
    CLOSE cs_KHACHHANG;
END PROC_DANHGIALKHTHEOTHANG;

begin
    PROC_DANHGIALKHTHEOTHANG(1);
end;

---RANG BUOC TOAN VEN: TONG TIEN BANG GIA * SO LUONG = SUM(THANHTIEN)
---Bï¿½?I Cáº¢NH: CTHD, HOADON1, MONAN
---         --THÃM---   ---XOA---   ---Sá»¬A----
----CTHD----   +            +           +(SL,THANHTIEN)

---START TRIGGER TRÃN Báº¢NG CTHD
---PROCUDURE UPDATE CTHD FOR TRIGGER INSSERT _ UPDATE
set serveroutput on size 30000;
CREATE OR REPLACE TRIGGER TRG_CTHD
BEFORE INSERT OR UPDATE
    ON CN1.CTHD
    FOR EACH ROW
DECLARE
    CURSOR CS_TT IS
        SELECT CTHD.THANHTIEN
        FROM CN1.CTHD
        WHERE MAHD = :NEW.MAHD;
    CS_THANHTIEN DECIMAL;
    TRG_DONGIA DECIMAL;
    TRG_THANHTIEN DECIMAL;
    TRG_TONGTIEN DECIMAL;
    TRG_TONGTIEN_HD DECIMAL;
BEGIN
    SELECT DONGIA INTO TRG_DONGIA
    FROM CN1.MONAN
    WHERE MAMA = :NEW.MAMA;
    
    TRG_THANHTIEN := :NEW.SL * TRG_DONGIA;
    
    IF TRG_THANHTIEN <> :NEW.THANHTIEN THEN
        raise_application_error(-20111,'khong hop le');
        ROLLBACK;
    ELSE
        ---LAM VIEC TREN BANG HD1
        SELECT TONGTIEN INTO TRG_TONGTIEN_HD
        FROM CN1.HOADON1
        WHERE MAHD = :NEW.MAHD;
        
        TRG_TONGTIEN := 0;
        OPEN CS_TT;
            LOOP
                FETCH CS_TT INTO CS_THANHTIEN;
                EXIT WHEN CS_TT%NOTFOUND;
                TRG_TONGTIEN := TRG_TONGTIEN + CS_THANHTIEN;
            END LOOP;
        CLOSE CS_TT;
        TRG_TONGTIEN := TRG_TONGTIEN + TRG_THANHTIEN;
        IF TRG_TONGTIEN <> TRG_TONGTIEN_HD THEN
            UPDATE CN1.HOADON1
            SET TONGTIEN = TRG_TONGTIEN
            WHERE MAHD = :NEW.MAHD;
        END IF;
    END IF;
END;

insert into  cn1.cthd values ('HD40', 'MA16', 1, 25000);

SELECT * FROM CN1.MONAN;
select * from cn1.cthd;
SELECT * FROM CN1.HOADON1;


DELETE CN1.CTHD
WHERE MAHD = 'HD40' AND MAMA = 'MA16';

--- TRIGGER XOA TRE BANG CTHD
DROP TRIGGER TRG_HD1_UPDATE;
-------------------------------------------------------------
CREATE OR REPLACE TRIGGER TRG_CTHD_DEL
AFTER DELETE
    ON cn1.CTHD
    FOR EACH ROW
DECLARE
    TRG_THANHTIEN DECIMAL;
    TRG_TONGTIEN DECIMAL;
    TRG_TONGTIEN_HD DECIMAL;
BEGIN   
    TRG_THANHTIEN := :OLD.THANHTIEN;
    SELECT TONGTIEN INTO TRG_TONGTIEN_HD
    FROM cn1.HOADON1
    WHERE MAHD = :OLD.MAHD;
    TRG_TONGTIEN := TRG_TONGTIEN_HD - TRG_THANHTIEN;
        UPDATE cn1.HOADON1 
        SET TONGTIEN  = TRG_TONGTIEN
        WHERE MAHD = :OLD.MAHD;
END;

DELETE CN1.CTHD
WHERE MAHD =  'HD40' AND MAMA = 'MA16';


SELECT * FROM CN1.HOADON1;
SELECT * FROM CN1.CTHD;
--DU LIEU TEST

-----TRIGGER UPDATE TREN BANG HOADON1
CREATE OR REPLACE TRIGGER TRG_HD1_UPDATE
BEFORE  UPDATE
    ON cn1.HOADON1
    FOR EACH ROW
DECLARE
    CURSOR CS_CTHD IS
        SELECT THANHTIEN
        FROM CN1.CTHD
        WHERE MAHD = :NEW.MAHD;
        
    TRG_TONGTIEN DECIMAL;
    TRG_TONGTIEN_HD DECIMAL;
    CS_THANHTIEN DECIMAL;    
BEGIN   
    TRG_TONGTIEN_HD := :NEW.TONGTIEN;
    
    TRG_TONGTIEN := 0;
    OPEN CS_CTHD;
        LOOP
            FETCH CS_CTHD INTO CS_THANHTIEN;
            EXIT WHEN CS_CTHD%NOTFOUND;
            TRG_TONGTIEN := TRG_TONGTIEN + CS_THANHTIEN;
        END LOOP;
    CLOSE CS_CTHD; 
    
    IF TRG_TONGTIEN_HD = TRG_TONGTIEN THEN 
        dbms_output.put_line(N'CAP NHAT THANH CONG!');
    ELSE 
        raise_application_error(-20111,N'TONG TIEN PHAI BANG TONG THANH TIEN!');
        ROLLBACK;
    END IF;
END;


UPDATE CN1.HOADON1
SET TONGTIEN = 100
WHERE MAHD = 'HD01'

ROLLBACK;
SELECT * FROM CN1.HOADON1

-- Cau 6: TRUONG CHI NHANH: TINH TONG DOANH THU MOI QUY
SELECT * FROM CN1.HOADON2;
SELECT QUY, SUM(TONGTIEN)
FROM (
    SELECT HD2.MAHD, PROC_QUY(NGAYHD) AS QUY, TONGTIEN
    FROM CN1.HOADON2 HD2, CN1.HOADON1 HD1
    WHERE HD1.MAHD = HD2.MAHD)
GROUP BY QUY;

CREATE OR REPLACE FUNCTION PROC_QUY(PROC_NGAY IN DATE)
    RETURN NUMBER
IS
    QUY NUMBER;
    THANG NUMBER;
BEGIN
    THANG := extract(month from PROC_NGAY);
    
    IF THANG <= 3 THEN QUY := 1;
    ELSIF THANG <= 6 THEN QUY := 2;
    ELSIF THANG <= 9 THEN QUY := 3;
    ELSE QUY := 4;
    END IF;
    
    RETURN QUY;  
END;

---CAU 7: Tï¿½M  KHACH HANG DO DA MUA MON AN O CA HAI CUA HANG
----DUA RA THONG TIN GOM  TENKH, GIOITINHKH, SUM(TONGTIEN)
CREATE VIEW KH_MA AS
    SELECT * FROM 
        (SELECT MAKH
        FROM CN1.HOADON1 HD1
    INTERSECT
        SELECT MAKH
        FROM CN2.HOADON1@DBLINK HD1)
        
SELECT A.MAKH, TENKH, GIOITINH, TONG 
FROM (
    SELECT MAKH, SUM(TT) AS TONG
    FROM 
        (SELECT V.MAKH, SUM(TONGTIEN) AS TT
        FROM CN1.KH_MA V, CN1.HOADON1  HD1
        WHERE V.MAKH = HD1.MAKH 
        GROUP BY V.MAKH
        UNION ALL
        SELECT V.MAKH, SUM(TONGTIEN) AS TT
        FROM CN1.KH_MA V, CN2.HOADON1@DBLINK  HD1
        WHERE V.MAKH = HD1.MAKH 
        GROUP BY V.MAKH)
    GROUP BY MAKH) A, CN1.KHACHHANG KH
WHERE A.MAKH = KH.MAKH AND GIOITINH = 'Nu' AND ROWNUM = 1
ORDER BY TONG DESC

SELECT * FROM CN1.KH_MA

--CAU 8: TIM KHACH HANG DA MUA TAT CA MON AN TRU GA KHO  --  chia
SELECT * 
FROM cn1.KHACHHANG KH
WHERE NOT EXISTS(SELECT * FROM cn1.MONAN MA
                WHERE NOT EXISTS (
                    SELECT * FROM (
                            SELECT * FROM cn1.HOADON1 HD1, cn1.CTHD@dblCN1 CT
                                WHERE HD1.MAHD =CT.MAHD
                            UNION 
                            SELECT * FROM cn2.HOADON1@dblink HD2, cn2.CTHD@dblink CT
                                WHERE HD2.MAHD =CT.MAHD ) HD
                    WHERE HD.MAKH = KH.MAKH AND HD.MAMA = MA.MAMA AND TENMA <>'GA KHO')
                    )

 --Cau 9: KHACHHANG: TINH TONG TIEN CUA MOI KHACHHANG. DUA RA THONG MAKH, TENKH, GIOITINH, SUM(TONGTIEN) 
SELECT KH.MAKH, TENKH, GIOITINH, SUM(TONGTIEN) 
FROM CN1.KHACHHANG KH, CN1.HOADON1 HD
WHERE KH.MAKH = HD.MAKH
GROUP BY KH.MAKH, TENKH, GIOITINH

--CAU 10: NHANVIEN:  TINH TY LE SL MON AN BAN  TRONG NAM HIEN TAI

SELECT MAMA, PROC_TYLE(MAMA) AS SLUONG
FROM CN1.MONAN

CREATE OR REPLACE FUNCTION PROC_TYLE(PROC_MAMA IN VARCHAR2)
    RETURN DECIMAL
IS
    TYLE DECIMAL;
    TONGSL DECIMAL;
    TONGSLMA DECIMAL;
BEGIN
    SELECT SUM(SL) INTO TONGSLMA
    FROM CN1.CTHD
    WHERE MAMA = PROC_MAMA
    GROUP BY MAMA;
    
    SELECT SUM(SL) INTO TONGSL
    FROM CN1.CTHD;
   
    IF TONGSL IS NULL THEN TYLE := 0.0;
    ELSE  TYLE := TONGSLMA/TONGSL * 100;
    END IF;
    RETURN TYLE;  
END;

COMMIT;

---- M?C Cï¿½ L?P 
declare 
           trans_id Varchar2(100);
        begin
           trans_id := dbms_transaction.local_transaction_id( TRUE );
        end;
        
----XXEM MUC CO LAP
    SELECT s.sid, s.serial#,
       CASE BITAND(t.flag, POWER(2, 28))
          WHEN 0 THEN 'READ COMMITTED'
          ELSE 'SERIALIZABLE'
       END AS isolation_level
    FROM v$transaction t 
    JOIN v$session s ON t.addr = s.taddr AND s.sid = sys_context('USERENV', 'SID');
---SET MUC CO LAP
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
----
delete cn1.monan
where mama = 'MA21'
SELECT * FROM CN1.MONAN;

-----5.1	NON-REPEATABLE READ
SELECT * 
FROM cn2.MONAN@dblink
WHERE func_COMPARE(MAMA) <3;

COMMIT;
-----5.2	PHANTOM READ
SELECT * 
FROM cn2.MONAN@dblink
WHERE DONGIA >= 30000;

COMMIT;
------5.3	LOST UPDATE
SELECT * 
FROM cn2.MONAN@dblink
WHERE func_COMPARE(MAMA) <4;

UPDATE cn2.MONAN@dblink
SET TENMA = 'Ga kho xa ot'
WHERE TENMA = 'Ga kho';

UPDATE cn2.MONAN@dblink
SET TENMA = 'Ga kho'
WHERE TENMA = 'Ga kho xa ot';

COMMIT;



COMMIT;
----5.4	DEADLOCK
SELECT * FROM CN2.MONAN@DBLINK
WHERE func_COMPARE(MAMA) <5;

UPDATE cn2.MONAN@DBLINK 
SET TENMA = 'Vit quay tieu' 
WHERE MAMA='MA01';

UPDATE cn2.MONAN@DBLINK 
SET TENMA = 'Rau muong xao toi' 
WHERE MAMA='MA02';


SELECT * FROM CN2.MONAN@DBLINK
WHERE func_COMPARE(MAMA) <5;


UPDATE cn2.MONAN@DBLINK 
SET TENMA = 'Vit quay tieu' 
WHERE MAMA='MA03';

UPDATE cn2.MONAN@DBLINK 
SET TENMA = 'Rau muong xao toi' 
WHERE MAMA='MA04';

COMMIT;


begin 
    PROC_insertma('Suon xao chua ngot', 50000);
end;

begin 
    PROC_insertma('Tom hap', 500000);
end;

COMMIT;

create or replace procedure PROC_insertma (PROC_TENMA varchar2, PROC_DONGIA DECIMAL)
AS
    MAMAX NUMBER;
    MAMA VARCHAR2(4);
BEGIN
    SELECT func_COMPARE(MAMA) into MAMAX
    FROM (
        SELECT MAMA
        FROM CN1.MONAN
        ORDER BY MAMA DESC)
    WHERE ROWNUM = 1;
    
    MAMAX := MAMAX + 1;
    
    SELECT CONCAT('MA',MAMAX) INTO MAMA
    FROM dual;
    
    INSERT INTO CN1.MONAN VALUES(MAMA, PROC_TENMA, PROC_DONGIA);
    INSERT INTO CN2.MONAN@dblink VALUES(MAMA, PROC_TENMA, PROC_DONGIA);
END;





create or replace function func_COMPARE (proc_str varchar2)
return number
is
   MA NUMBER; 
BEGIN
    SELECT SUBSTR(proc_str,3,2)INTO MA
    FROM dual;
    
    RETURN MA;
END;


create or replace procedure PROC_TANGGIA (proc_mama varchar2, tyle DECIMAL)
AS
BEGIN
    UPDATE cn2.MONAN@dblink 
    SET DONGIA = DONGIA + DONGIA*tyle
    WHERE MAMA = proc_mama;
    
    UPDATE cn1.MONAN
    SET DONGIA = DONGIA + DONGIA*tyle
    WHERE MAMA = proc_mama;
END;